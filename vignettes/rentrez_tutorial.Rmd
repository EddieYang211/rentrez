---
title: Rentrez Tutorial
author: "David winter"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

 
```{r, eval=TRUE, echo=FALSE}
library(knitr)
opts_knit$set(upload.fun = image_uri)
opts_knit$set(fig.keep = "last")
opts_knit$set(fig.show = "hold")

```
## rentrez, entrez and the NCBI

`rentrez` allows you to acess the [NCBI's Entrez Utilities API](http://www.ncbi.nlm.nih.gov/books/NBK25500/) 
, and thus the tens of millions of records in databases like GenBank and Pubmed,
from  the comfort of an R session. Specifically, this packages provies functions
that search the NCBI's databases, discover cross-referenced records, and fetch 
records from the NCBI. 


## Getting started with the rentrez

`rentrez` gives you a few tools that help you to get to know your way around the
NCBI's databases. First, you can use `entrez_dbs()` to find out just what
databases are avaliable:

```{r, dbs}
library(rentrez)
entrez_dbs()
```

You can find out a bit more about each of those database using a set of
functions with names starting `entrez_db_`:

| Function name            | Return                                               |
|--------------------------|------------------------------------------------------|
| `entrez_db_summary()`    | Brief description of what the database is            |
| `entrez_db_searchable()` | Set of search terms that can used with this database |
| `entrez_db_links() `     | Set of databases that might contain linked records   |

For instance, we can find out a little more about the cryptically named
database 'cdd'...

```{r, cdd}
entrez_db_summary("cdd")
```

... or fin
d out which search terms can be used with the Short Read Archive (SRA)
sequencing database:

```{r, sra_eg}
entrez_db_searchable("sra")
```

# Searching databases: `entrez_search`

The function  `entrez_search()` to discover records in each available database.
You provide a database name (`db`) and a search term(`term`). If you print the
returned object you get a summary of what it contains, and the way the NCBI's
servers translated your query:

```{r eg_search}
r_search <- entrez_search(db="pubmed", term="R Language")
r_search
```
There are a few things to note here. First, the NCBI's server has worked out
that we meant R as a programming language, and so inlcuded the 
['MeSh' term](http://www.ncbi.nlm.nih.gov/mesh). We'll worry about these and
other search terms in a second. Second, there are many more 'hits' for this search than there
are unique IDs contained in this object. That's because the optional argument
`retmax`, which controls the maximum number of returned values has a default
value of 20. We can acess those 20 IDs like this:


```{r search_ids}
r_search$ids
```

And get more IDs by increasing the `ret_max` argument. 

```{r searchids_2}
another_r_search <- entrez_search(db="pubmed", term="R Language", retmax=40)
another_r_search
```

If we want to get IDs for all of those thousands of records that match this
search, we can use the NCBI's web history feature. We'll learn how to make the
most of these features in (SECTION), for now let's just fetch some web history
information. To do that we set the argument `use_history` to `y`. The returned 
object tells you in contains a cookie for the web history methods:


```{r, search_ids3}
yet_another_r_search <- entrez_search(db="pubmed", 
                                      term="R Language", 
                                      retmax=0,
                                      usehistory="y")
yet_another_r_search
yet_another_r_search$WebEnv
```

### Building search terms

The EUtils api uses a special syntax to build search queries. You can search a
database against a specific term using the format `query[SEARCH TERM]`, and 
combine multiple such seaches using the operators `AND`, `OR` and `NOT`.

For instance, we can find next generation sequence datasets for the (amazing...) ciliate
_Tetrahymena thermophila_ by using the organism ('ORGN') search field:


```{r, Tt}
entrez_search(db="sra", 
              term="Tetrahymena thermophila[ORGN]",
              retmax=0)
```

Find only those records that have been added recently (using the colon to
sepcify a range of values):

```{r, Tt2}
entrez_search(db="sra", 
              term="Tetrahymena thermophila[ORGN] AND 2013:2015[PDAT]",
              retmax=0)
```

Or recently records for either _T. thermophila_ or it's close relative _T.
borealis_ (using parentheses to make ANDs and ORs explicit).

```{r, Tt3}
entrez_search(db="sra", 
              term="(Tetrahymena thermophila[ORGN] OR Tetrahymena borealis[ORGN]) AND 2013:2015[PDAT]",
              retmax=0)
```

Remember, you can use `entrez_db_searchable()` to get a list and brief
description of a databases' available search terms. 

### Advanced counting

As you can see above, the  object returned by `entrez_search()` includes the the 
number of records matching a given search. This means you can learn a little
about the composition of, or trends in, the records stored in the NCBI's
databases using only the search utility. For instance, let's track the raise of
the buzzword "connectome"in pubmed, programatically creating  search terms for
the `PDAT` field:

```{r, connectome}
eras <- c("1960:2008", "2009:2012", "2013", "2014")
sapply(eras, function(x) 
  entrez_search(db="pubmed", term=paste("Connectome AND", x, "[PDAT]"), retmax=0)$count
)

```

## Getting summary data: `entrez_summary()`

`entrez_search` helps you discover


```{r, Summ_1}
Tt_search <- entrez_search(db="pubmed", 
                           term="Tetrahymena thermophila[ORGN]", 
                           retmax=10)
Tt_search$ids
```

```{r, Summ_2}
pmed_summ <- entrez_summary(db="pubmed", id=Tt_search$ids[1])
pmed_summ
```

```{r, Summ_3}
pmed_summ$articleids
```


```{r, multi_summ}
summs <- entrez_summary(db="pubmed", id=Tt_search$ids)
extract_from_esummary(summs, "fulljournalname")
```

```{r, multi_summ2}
extract_from_esummary(summs, c("pubdate", "fulljournalname"))
```

[Need description of version/always list args]












